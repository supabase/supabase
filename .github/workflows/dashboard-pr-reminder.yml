name: Dashboard PR Reminder

on:
  schedule:
    # Run daily at 9 AM UTC (adjust as needed)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger for testing
  push: # TODO Remove before merging to main
    branches:
      - 'aliwaseem/fe-2076-create-slackbot-to-ping-prs-that-are-over-the-24-sla' # Testing branch only (remove before merging to main)

permissions:
  pull-requests: read
  contents: read

jobs:
  check-dashboard-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Find Dashboard PRs older than 24 hours
        id: find-prs
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const TWENTY_FOUR_HOURS_AGO = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const DASHBOARD_PATH = 'apps/studio/';

            console.log(`Looking for PRs older than: ${TWENTY_FOUR_HOURS_AGO.toISOString()}`);

            const stalePRs = [];
            let page = 1;
            let hasMore = true;

            // Fetch PRs page by page, newest first
            while (hasMore && page <= 10) { // Limit to 10 pages (1000 PRs) as safety measure
              console.log(`Fetching page ${page}...`);
              
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'created',
                direction: 'desc',
                per_page: 100,
                page: page
              });
              
              if (prs.length === 0) {
                hasMore = false;
                break;
              }
              
              // Check each PR
              for (const pr of prs) {
                // Skip PRs from forks - only check internal PRs
                if (pr.head.repo && pr.head.repo.full_name !== context.repo.owner + '/' + context.repo.repo) {
                  console.log(`PR #${pr.number} is from a fork, skipping...`);
                  continue;
                }
                
                const createdAt = new Date(pr.created_at);
                
                // If this PR is newer than 24 hours, skip it
                if (createdAt > TWENTY_FOUR_HOURS_AGO) {
                  console.log(`PR #${pr.number} is too new, skipping...`);
                  continue;
                }
                
                // If we've reached PRs older than what we're checking, we can stop
                // But we still need to check if they touch Dashboard files
                console.log(`Checking PR #${pr.number}: ${pr.title}`);
                
                // Fetch files changed in this PR
                const { data: files } = await github.rest.pulls.listFiles({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  per_page: 100
                });
                
                // Check if any file is under apps/studio/
                const touchesDashboard = files.some(file => file.filename.startsWith(DASHBOARD_PATH));
                
                if (touchesDashboard) {
                  const hoursOld = Math.floor((Date.now() - createdAt.getTime()) / (1000 * 60 * 60));
                  const daysOld = Math.floor(hoursOld / 24);
                  
                  stalePRs.push({
                    number: pr.number,
                    title: pr.title,
                    url: pr.html_url,
                    author: pr.user.login,
                    createdAt: pr.created_at,
                    hoursOld: hoursOld,
                    daysOld: daysOld,
                    fileCount: files.filter(f => f.filename.startsWith(DASHBOARD_PATH)).length
                  });
                  
                  console.log(`‚úì Found stale Dashboard PR #${pr.number}`);
                }
              }
              
              page++;
            }

            console.log(`Found ${stalePRs.length} stale Dashboard PRs`);

            // Sort by age (oldest first)
            stalePRs.sort((a, b) => a.hoursOld - b.hoursOld);

            // Store results for next step
            core.setOutput('stale_prs', JSON.stringify(stalePRs));
            core.setOutput('count', stalePRs.length);

            return stalePRs;

      - name: Send Slack notification
        if: fromJSON(steps.find-prs.outputs.count) > 0
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DASHBOARD_WEBHOOK_URL }}
        with:
          script: |
            const stalePRs = JSON.parse('${{ steps.find-prs.outputs.stale_prs }}');
            const count = ${{ steps.find-prs.outputs.count }};

            // Build PR blocks
            const prBlocks = stalePRs.map(pr => {
              // Format age display
              const remainingHours = pr.hoursOld % 24;
              const ageText = pr.daysOld > 0 
                ? `${pr.daysOld}d ${remainingHours}h`
                : `${pr.hoursOld}h`;
              
              return {
                type: "section",
                text: {
                  type: "mrkdwn",
                  text: `*<${pr.url}|#${pr.number}: ${pr.title}>*\nüë§ @${pr.author} ‚Ä¢ ‚è∞ ${ageText} old ‚Ä¢ üìÅ ${pr.fileCount} Dashboard files`
                }
              };
            });

            // Build complete Slack message
            const slackMessage = {
              text: "Dashboard PRs needing attention",
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "üîî Dashboard PRs Older Than 24 Hours"
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `There are *${count}* open PRs affecting \`/apps/studio/\` that are older than 24 hours:`
                  }
                },
                {
                  type: "divider"
                },
                ...prBlocks
              ]
            };

            // Send to Slack
            const webhookUrl = process.env.SLACK_WEBHOOK_URL;
            const response = await fetch(webhookUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(slackMessage)
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Slack notification failed: ${response.status} ${response.statusText}\n${errorText}`);
            }

            console.log('‚úì Slack notification sent successfully!');

      - name: No stale PRs found
        if: fromJSON(steps.find-prs.outputs.count) == 0
        run: |
          echo "‚úì No Dashboard PRs older than 24 hours found"
