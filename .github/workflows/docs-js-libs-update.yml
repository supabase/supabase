name: Update JS Client Libraries Docs

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version that was released (e.g., patch, minor, major, or v2.1.0)'
        required: true
        type: string
      source:
        description: 'Source of the documentation update'
        required: false
        type: string
        default: 'manual'

permissions:
  pull-requests: write
  contents: write

jobs:
  update-docs:
    runs-on: blacksmith-4vcpu-ubuntu-2404

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: master

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        name: Install pnpm
        with:
          run_install: false

      - name: Use Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Regenerate JS client libraries tsdoc files
        working-directory: apps/docs/spec
        run: |
          echo "Regenerating tsdoc files for JS client libraries..."
          echo "Source: ${{ github.event.inputs.source }}"
          echo "Version: ${{ github.event.inputs.version }}"
          make

      - name: Generate new typespec snapshot
        working-directory: apps/docs
        run: |
          echo "Generating new typespec snapshot for review..."
          npx vitest run --update ./features/docs/Reference.typeSpec.test.ts

      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf
        with:
          app-id: ${{ secrets.GH_AUTOFIX_APP_ID }}
          private-key: ${{ secrets.GH_AUTOFIX_PRIVATE_KEY }}

      - name: Create pull request
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6.1.0
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: 'docs: update js sdk docs (${{ github.event.inputs.version }})'
          title: 'docs: update js sdk docs (${{ github.event.inputs.version }})'
          body: |
            Updates JS sdk documentation following stable release. 
            Ran `make` in apps/docs/spec to regenerate tsdoc files.

            **Details:**
            - **Version:** `${{ github.event.inputs.version }}`
            - **Source:** `${{ github.event.inputs.source }}`
            - **Changes:** Regenerated tsdoc files from latest spec files

            ðŸ¤– Auto-generated from @supabase/supabase-js stable release.
          branch: 'gha/update-js-sdk-docs-${{ github.run_number }}'
          base: 'master'
