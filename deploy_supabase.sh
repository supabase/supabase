#!/bin/bash

# Script để triển khai nhiều stack Supabase trên cùng một VM mà không xung đột
# Usage: ./deploy_supabase.sh <stack_name>

set -e

# Kiểm tra tham số dòng lệnh
if [ $# -lt 1 ]; then
    echo "Usage: $0 <stack_name>"
    echo "Example: $0 project1"
    exit 1
fi

STACK_NAME=$1
DOCKER_DIR="$(pwd)/docker"
TARGET_DIR="$(pwd)/${STACK_NAME}"

# Tạo các password và token ngẫu nhiên
generate_random_string() {
    local length=$1
    cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w $length | head -n 1
}

generate_jwt() {
    # Tạo một JWT secret với ít nhất 32 ký tự
    generate_random_string 32
}

# Tạo các giá trị cần thiết
POSTGRES_PASSWORD=$(generate_random_string 30)
JWT_SECRET=$(generate_jwt)

# Sử dụng giá trị iat cố định và tính toán exp chính xác 5 năm sau
IAT_TIMESTAMP=1743440400
EXPIRY_TIMESTAMP=$((IAT_TIMESTAMP + 157680000)) # 5 năm tính bằng giây (60*60*24*365*5)

# Generate properly signed JWT tokens
generate_jwt_token() {
    local role=$1
    local secret=$2
    
    # Create header and payload (as JSON) với iat cố định
    local header='{"alg":"HS256","typ":"JWT"}'
    local payload="{\"role\":\"$role\",\"iss\":\"supabase\",\"iat\":${IAT_TIMESTAMP},\"exp\":${EXPIRY_TIMESTAMP}}"
    
    # Base64url encode header và payload
    local base64_header=$(echo -n "$header" | base64 | tr '+/' '-_' | tr -d '=')
    local base64_payload=$(echo -n "$payload" | base64 | tr '+/' '-_' | tr -d '=')
    
    # Tạo chữ ký
    local signature=$(echo -n "$base64_header.$base64_payload" | openssl dgst -binary -sha256 -hmac "$secret" | base64 | tr '+/' '-_' | tr -d '=')
    
    # Trả về JWT hoàn chỉnh
    echo "$base64_header.$base64_payload.$signature"
}

ANON_KEY=$(generate_jwt_token "anon" "$JWT_SECRET")
SERVICE_ROLE_KEY=$(generate_jwt_token "service_role" "$JWT_SECRET")

DASHBOARD_PASSWORD=$(generate_random_string 16)
SECRET_KEY_BASE=$(generate_random_string 64)
VAULT_ENC_KEY=$(generate_random_string 32)
LOGFLARE_API_KEY=$(generate_random_string 32)
POOLER_TENANT_ID=$(generate_random_string 16)

echo "Preparing to deploy Supabase stack: ${STACK_NAME}"
echo "Creating directory structure..."

# Tạo thư mục cho stack mới
if [ -d "$TARGET_DIR" ]; then
    echo "Directory $TARGET_DIR already exists. Do you want to overwrite it? (y/N)"
    read -p "> " OVERWRITE
    if [ "$OVERWRITE" != "y" ] && [ "$OVERWRITE" != "Y" ]; then
        echo "Aborting."
        exit 1
    fi
    rm -rf "$TARGET_DIR"
fi

mkdir -p "$TARGET_DIR"
mkdir -p "$TARGET_DIR/volumes/db/data"
mkdir -p "$TARGET_DIR/volumes/storage"
mkdir -p "$TARGET_DIR/volumes/functions"
mkdir -p "$TARGET_DIR/dev"

# Tính toán ports cho stack mới (mỗi stack tăng 1000 port)
# Lấy danh sách các stack đã tồn tại để tính toán port offset
PORT_OFFSET=0
for d in */; do
    if [[ "$d" != "docker/" && -d "$d" && -f "${d}docker-compose.yml" ]]; then
        PORT_OFFSET=$((PORT_OFFSET + 1))
    fi
done

# Base ports
BASE_KONG_HTTP_PORT=8000
BASE_KONG_HTTPS_PORT=8443
BASE_POSTGRES_PORT=5432
BASE_STUDIO_PORT=3000
BASE_POOLER_PORT=6543
BASE_ANALYTICS_PORT=4000

# Calculate ports for new stack
KONG_HTTP_PORT=$((BASE_KONG_HTTP_PORT + PORT_OFFSET * 1000))
KONG_HTTPS_PORT=$((BASE_KONG_HTTPS_PORT + PORT_OFFSET * 1000))
POSTGRES_PORT=$((BASE_POSTGRES_PORT + PORT_OFFSET * 1000))
STUDIO_PORT=$((BASE_STUDIO_PORT + PORT_OFFSET * 1000))
POOLER_PORT=$((BASE_POOLER_PORT + PORT_OFFSET * 1000))
ANALYTICS_PORT=$((BASE_ANALYTICS_PORT + PORT_OFFSET * 1000))

echo "This stack will use the following ports:"
echo "Kong HTTP: ${KONG_HTTP_PORT}"
echo "Kong HTTPS: ${KONG_HTTPS_PORT}"
echo "Postgres: ${POSTGRES_PORT}"
echo "Studio: ${STUDIO_PORT}"
echo "Pooler: ${POOLER_PORT}"
echo "Analytics: ${ANALYTICS_PORT}"

# Sao chép và sửa đổi các file cấu hình cần thiết
echo "Copying and modifying configuration files..."

# Copy các thư mục cần thiết
cp -r "$DOCKER_DIR/volumes/api" "$TARGET_DIR/volumes/"
cp -r "$DOCKER_DIR/volumes/db/init" "$TARGET_DIR/volumes/db/"
cp -r "$DOCKER_DIR/volumes/db/_supabase.sql" "$TARGET_DIR/volumes/db/"
cp -r "$DOCKER_DIR/volumes/db/jwt.sql" "$TARGET_DIR/volumes/db/"
cp -r "$DOCKER_DIR/volumes/db/logs.sql" "$TARGET_DIR/volumes/db/"
cp -r "$DOCKER_DIR/volumes/db/pooler.sql" "$TARGET_DIR/volumes/db/"
cp -r "$DOCKER_DIR/volumes/db/realtime.sql" "$TARGET_DIR/volumes/db/"
cp -r "$DOCKER_DIR/volumes/db/roles.sql" "$TARGET_DIR/volumes/db/"
cp -r "$DOCKER_DIR/volumes/db/webhooks.sql" "$TARGET_DIR/volumes/db/"
cp -r "$DOCKER_DIR/volumes/logs" "$TARGET_DIR/volumes/"
cp -r "$DOCKER_DIR/volumes/pooler" "$TARGET_DIR/volumes/"
cp -r "$DOCKER_DIR/dev/data.sql" "$TARGET_DIR/dev/"
cp "$DOCKER_DIR/docker-compose.yml" "$TARGET_DIR/"
cp "$DOCKER_DIR/docker-compose.s3.yml" "$TARGET_DIR/"
cp "$DOCKER_DIR/dev/docker-compose.dev.yml" "$TARGET_DIR/dev/"

# Tạo file .env với các giá trị ngẫu nhiên đã tạo
cat > "$TARGET_DIR/.env" << EOL
############
# Secrets - Auto-generated by deploy script
############

POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
JWT_SECRET=${JWT_SECRET}
ANON_KEY=${ANON_KEY}
SERVICE_ROLE_KEY=${SERVICE_ROLE_KEY}
DASHBOARD_USERNAME=supabase
DASHBOARD_PASSWORD=${DASHBOARD_PASSWORD}
SECRET_KEY_BASE=${SECRET_KEY_BASE}
VAULT_ENC_KEY=${VAULT_ENC_KEY}

############
# Database
############

POSTGRES_HOST=db
POSTGRES_DB=postgres
POSTGRES_PORT=${POSTGRES_PORT}

############
# Supavisor -- Database pooler
############
POOLER_PROXY_PORT_TRANSACTION=${POOLER_PORT}
POOLER_DEFAULT_POOL_SIZE=20
POOLER_MAX_CLIENT_CONN=100
POOLER_TENANT_ID=${POOLER_TENANT_ID}

############
# API Proxy - Configuration for the Kong Reverse proxy.
############

KONG_HTTP_PORT=${KONG_HTTP_PORT}
KONG_HTTPS_PORT=${KONG_HTTPS_PORT}

############
# API - Configuration for PostgREST.
############

PGRST_DB_SCHEMAS=public,storage,graphql_public

############
# Auth - Configuration for the GoTrue authentication server.
############

## General
SITE_URL=http://localhost:${STUDIO_PORT}
ADDITIONAL_REDIRECT_URLS=
JWT_EXPIRY=3600
DISABLE_SIGNUP=false
API_EXTERNAL_URL=http://localhost:${KONG_HTTP_PORT}

## Mailer Config
MAILER_URLPATHS_CONFIRMATION="/auth/v1/verify"
MAILER_URLPATHS_INVITE="/auth/v1/verify"
MAILER_URLPATHS_RECOVERY="/auth/v1/verify"
MAILER_URLPATHS_EMAIL_CHANGE="/auth/v1/verify"

## Email auth
ENABLE_EMAIL_SIGNUP=true
ENABLE_EMAIL_AUTOCONFIRM=false
SMTP_ADMIN_EMAIL=admin@example.com
SMTP_HOST=supabase-mail
SMTP_PORT=2500
SMTP_USER=fake_mail_user
SMTP_PASS=fake_mail_password
SMTP_SENDER_NAME=fake_sender
ENABLE_ANONYMOUS_USERS=false

## Phone auth
ENABLE_PHONE_SIGNUP=true
ENABLE_PHONE_AUTOCONFIRM=true

############
# Studio - Configuration for the Dashboard
############

STUDIO_DEFAULT_ORGANIZATION=Default Organization
STUDIO_DEFAULT_PROJECT=${STACK_NAME}

STUDIO_PORT=${STUDIO_PORT}
# replace if you intend to use Studio outside of localhost
SUPABASE_PUBLIC_URL=http://localhost:${KONG_HTTP_PORT}

# Enable webp support
IMGPROXY_ENABLE_WEBP_DETECTION=true

# Add your OpenAI API key to enable SQL Editor Assistant
OPENAI_API_KEY=

############
# Functions - Configuration for Functions
############
# NOTE: VERIFY_JWT applies to all functions. Per-function VERIFY_JWT is not supported yet.
FUNCTIONS_VERIFY_JWT=false

############
# Logs - Configuration for Logflare
############

LOGFLARE_LOGGER_BACKEND_API_KEY=${LOGFLARE_API_KEY}
LOGFLARE_API_KEY=${LOGFLARE_API_KEY}
DOCKER_SOCKET_LOCATION=/var/run/docker.sock
EOL

# Sửa đổi docker-compose.yml để thêm tên stack và thay đổi tên container
sed -i'' -e "s/name: supabase/name: ${STACK_NAME}/g" "$TARGET_DIR/docker-compose.yml"
sed -i'' -e "s/container_name: supabase-/container_name: ${STACK_NAME}-/g" "$TARGET_DIR/docker-compose.yml"
# Thay đổi tên realtime container đặc biệt
sed -i'' -e "s/container_name: realtime-dev.supabase-realtime/container_name: realtime-dev.${STACK_NAME}-realtime/g" "$TARGET_DIR/docker-compose.yml"

# Thêm port cho Studio
echo "Adjusting port configurations in docker-compose.yml..."

# Thêm port cho studio
sed -i'' -e "/image: supabase\/studio:/a\\    ports:\\n      - ${STUDIO_PORT}:3000" "$TARGET_DIR/docker-compose.yml"

# Chỉnh sửa port cho analytics
sed -i'' -e "s/      - 4000:4000/      - ${ANALYTICS_PORT}:4000/g" "$TARGET_DIR/docker-compose.yml"

# Tạo script khởi động và tắt cho stack này
cat > "$TARGET_DIR/start.sh" << EOL
#!/bin/bash
cd "\$(dirname "\$0")"
docker compose up -d
echo "${STACK_NAME} stack started on:"
echo "Studio: http://localhost:${STUDIO_PORT}"
echo "API: http://localhost:${KONG_HTTP_PORT}"
echo "Database: localhost:${POSTGRES_PORT}"
EOL

cat > "$TARGET_DIR/stop.sh" << EOL
#!/bin/bash
cd "\$(dirname "\$0")"
docker compose down
echo "${STACK_NAME} stack stopped"
EOL

cat > "$TARGET_DIR/reset.sh" << EOL
#!/bin/bash
cd "\$(dirname "\$0")"
echo "WARNING: This will remove all containers and container data. This action cannot be undone!"
read -p "Are you sure you want to reset ${STACK_NAME} stack? (y/N) " -n 1 -r
echo
if [[ ! \$REPLY =~ ^[Yy]$ ]]
then
    echo "Operation cancelled."
    exit 1
fi

echo "Stopping and removing all containers..."
docker compose -f docker-compose.yml -f ./dev/docker-compose.dev.yml down -v --remove-orphans

echo "Cleaning up bind-mounted directories..."
rm -rf ./volumes/db/data

echo "${STACK_NAME} stack has been reset!"
EOL

# Phân quyền thực thi cho các script
chmod +x "$TARGET_DIR/start.sh"
chmod +x "$TARGET_DIR/stop.sh"
chmod +x "$TARGET_DIR/reset.sh"

echo "Stack ${STACK_NAME} has been prepared successfully!"
echo "To start your Supabase stack, run:"
echo "  cd ${STACK_NAME} && ./start.sh"
echo
echo "Access information:"
echo "Studio URL: http://localhost:${STUDIO_PORT}"
echo "API URL: http://localhost:${KONG_HTTP_PORT}"
echo "Database: localhost:${POSTGRES_PORT}"
echo "Database Password: ${POSTGRES_PASSWORD}"
echo
echo "All settings are saved in ${STACK_NAME}/.env"