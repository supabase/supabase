# Discord Bot for Hackathon submissions

## Helpful tutorials

- https://deno.com/deploy/docs/tutorial-discord-slash

## Create an application on Discord Developer Portal

1. Go to [https://discord.com/developers/applications](https://discord.com/developers/applications) (login using your discord account if required).
2. Click on **New Application** button available at left side of your profile picture.
3. Name your application and click on **Create**.
4. Go to **Bot** section, click on **Add Bot**, and finally on **Yes, do it!** to confirm.

That's it. A new application is created which will hold our Slash Command. Don't close the tab as we need information from this application page throughout our development.

Before we can write some code, we need to curl a discord endpoint to register a Slash Command in our app.

Fill `DISCORD_BOT_TOKEN` with the token available in the **Bot** section and `CLIENT_ID` with the ID available on the **General Information** section of the page and run the command on your terminal.

```bash
DISCORD_BOT_TOKEN='replace_me_with_discord_bot_token'
CLIENT_ID='replace_me_with_client_id'

curl -X POST \
-H 'Content-Type: application/json' \
-H "Authorization: Bot $DISCORD_BOT_TOKEN" \
-d '{"name":"promise","description":"Command to manage a coding challenge.","options":[{"name":"new","description":"Set a new challenge for yourself.","type":1,"options":[{"name":"promise","description":"What would you like to achieve?","type":3,"required":true}]},{"name":"resolve","description":"Mark your challenge as completed.","type":1,"options":[{"name":"submission","description":"Provide a link to your project (Website, GitHub, etc.).","type":3,"required":true}]}]}' \
"https://discord.com/api/v8/applications/$CLIENT_ID/commands"
```

Here a more readable representation of the body payload for the Slash Command creation request:

```json
{
  "name": "promise",
  "description": "Command to manage a coding challenge.",
  "options": [
    {
      "name": "new",
      "description": "Set a new challenge for yourself.",
      "type": 1,
      "options": [
        {
          "name": "promise",
          "description": "What would you like to achieve?",
          "type": 3,
          "required": true
        }
      ]
    },
    {
      "name": "resolve",
      "description": "Mark your challenge as completed.",
      "type": 1,
      "options": [
        {
          "name": "submission",
          "description": "Provide a link to your project (Website, GitHub, etc.).",
          "type": 3,
          "required": true
        }
      ]
    }
  ]
}
```

This will register a Slash Command named `hello` that accepts a parameter named `name` of type string.

## Deploy the Slash Command Handler

### Create a Database Table to store information

1. Navigate to the [SQL Editor in your Supabase Dashboard](https://app.supabase.com/project/_/sql).
2. Click "New Query".
3. Paste and run the SQL below:

```sql
create table discord_promise_challenge (
  id bigint generated by default as identity primary key,
  inserted_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id text not null,
  username text not null,
  promise text not null,
  email text,
  submission text,
  resolved boolean default false
);
alter table discord_promise_challenge enable row level security;
```

### Deploy the Functions

```bash
supabase functions deploy discord-bot --no-verify-jwt
supabase secrets set DISCORD_PUBLIC_KEY=your_public_key
```

Navigate to your Function details in the Supabase Dashboard to get your Endpoint URL.

### Configure Discord application to use our URL as interactions endpoint URL

1. Go back to your application (Greeter) page on Discord Developer Portal
2. Fill **INTERACTIONS ENDPOINT URL** field with the URL and click on **Save Changes**.

The application is now ready. Let's proceed to the next section to install it.

## Install the Slash Command on your Discord server

So to use the `hello` Slash Command, we need to install our Greeter application on our Discord server. Here are the steps:

1. Go to **OAuth2** section of the Discord application page on Discord Developer Portal
2. Select `applications.commands` scope and click on the **Copy** button below.
3. Now paste and visit the URL on your browser. Select your server and click on **Authorize**.

Open Discord, type `/Promise` and press **Enter**.

## Run locally

```bash
supabase functions serve discord-bot --no-verify-jwt --env-file ./supabase/functions/discord-bot/.env
```
