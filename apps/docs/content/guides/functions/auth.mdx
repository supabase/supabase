---
id: 'auth'
title: 'Securing Edge Functions'
description: 'Supabase Edge Functions and Auth.'
subtitle: 'Best practices on securing Edge Functions'
---

<Admonition type="note">

In the past Supabase Auth used a **symmetric** secret to sign legacy JWTs.
But it was replaced by the new [JWT Signing Keys](https://supabase.com/blog/jwt-signing-keys#start-using-asymmetric-jwts-today), in this guide we'll walkthought the new patterns for securing your Edge Functions.

If you still need to validate using the old method, please check the [Legacy JWT Secret](/docs/guides/functions/auth-legacy-jwt) guide

</Admonition>

Before continuing check the comprehensive guide on [JWT Signing Keys](docs/guides/auth/signing-keys) for all the details about the main differences compared to Legacy JWTs.

## Overview

When a HTTP request is sent to Edge Functions we can levarage to Supabase Auth to secure our endpoints, in the past this verification was controlled from [`verify_jwt` flag](http://localhost:3001/docs/guides/functions/function-configuration#skipping-authorization-checks).

But unfortunely this method is not compatible with the new [JWT Signing Keys](docs/guides/auth/signing-keys) and also caused a lot of trouble when trying to [third party integration](https://github.com/orgs/supabase/discussions/34988#discussion-8199151).

That's why we decided to not implicit force JWT verification anymore, but instead suggest patterns and templates to handle this task. It allow users to own and control the auth code, instead of hidding it internally under Edge Runtime infrastructure.

<Admonition type="warning">

Following the [Upcoming changes](https://github.com/orgs/supabase/discussions/29260) timetable, the `verify_jwt` flag will be still suported and enabled by default. In order to move to new [JWT Signing Keys](docs/guides/auth/signing-keys) you need to manually [skip the authorization checks](http://localhost:3001/docs/guides/functions/function-configuration#skipping-authorization-checks) and follow the steps bellow.

</Admonition>

## Verifying JWT

### Using Supabase template

We've prepared some [JWT verification](https://github.com/supabase/supabase/tree/master/examples/edge-functions/supabase/functions/custom-jwt-validation) templates, that can be found [here](https://github.com/supabase/supabase/tree/master/examples/edge-functions/supabase/functions/_shared/jwt).

In order to simple verify incoming requests you can download the specified template and start to using it:

```bash
curl -O https://raw.githubusercontent.com/supabase/supabase/refs/heads/master/examples/edge-functions/supabase/functions/_shared/jwt/default.ts
```

```ts
import { AuthMiddleware } from '../_shared/jwt/default.ts'

Deno.serve((r) =>
  AuthMiddleware(r, async (req) => {
    const { name } = await req.json()

    return Response.json({ message: `hello ${name}` })
  })
)
```

### Integrating with Supabase Auth

You can also use the Supabase Auth to verify users

```ts
import 'jsr:@supabase/functions-js/edge-runtime.d.ts'
import { createClient } from 'npm:@supabase/supabase-js@2'

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_PUBLISHABLE_KEY')!
)

Deno.serve(async (req) => {
  const authHeader = req.headers.get('Authorization')!
  const token = authHeader.replace('Bearer ', '')

  const { data, error } = await supabase.auth.getClaims(token)
  const userEmail = data?.claims?.email
  if (!userEmail || error) {
    return Response.json(
      { msg: 'Invalid JWT' },
      {
        status: 401,
      }
    )
  }

  return Response.json({ message: `hello ${userEmail}` })
})
```

### Using JWT library

The popular `jose` library can be used to verify received JWTs, like the following example:

```ts
import { createRemoteJWKSet, jwtVerify } from 'https://deno.land/x/jose@v4.14.4/index.ts'

const SUPABASE_JWT_ISSUER = SUPABASE_URL + '/auth/v1'
const SUPABASE_JWT_KEYS = createRemoteJWKSet(
  new URL(SUPABASE_JWT_ISSUER + '/.well-known/jwks.json')
)

function getAuthToken(req: Request) {
  const authHeader = req.headers.get('authorization')
  if (!authHeader) {
    throw new Error('Missing authorization header')
  }
  const [bearer, token] = authHeader.split(' ')
  if (bearer !== 'Bearer') {
    throw new Error(`Auth header is not 'Bearer {token}'`)
  }
  return token
}

function verifySupabaseJWT(jwt: string) {
  return jwtVerify(token, SUPABASE_JWT_KEYS, { issuer: SUPABASE_JWT_ISSUER })
}

Deno.serve(async (req: Request) => {
  if (req.method !== 'OPTIONS') {
    try {
      const token = getAuthToken(req)
      const isValidJWT = await verifySupabaseJWT(token)

      if (!isValidJWT) {
        return Response.json({ msg: 'Invalid JWT' }, {
          status: 401,
        })
      }
    } catch (e) {
      console.error(e)
      return Response.json({ msg: e.toString() }, {
        status: 401,
      })
    }
  }
}
```
