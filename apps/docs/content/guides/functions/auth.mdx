---
id: 'auth'
title: 'Securing Edge Functions'
description: 'Supabase Edge Functions and Auth.'
subtitle: 'Best practices on securing Edge Functions'
---

<Admonition type="note">

In the past Supabase Auth used a **symmetric** secret to sign legacy JWTs.
But it was replaced by the new [JWT Signing Keys](/blog/jwt-signing-keys#start-using-asymmetric-jwts-today), in this guide we'll walk through the new patterns for securing your Edge Functions.

If you still need to validate using the old method, check the [Legacy JWT Secret](/docs/guides/functions/auth-legacy-jwt) guide

</Admonition>

Before continuing check the comprehensive guide on [JWT Signing Keys](/docs/guides/auth/signing-keys) for all the details about the main differences compared to Legacy JWTs.

## Overview

When an HTTP request is sent to Edge Functions we can leverage Supabase Auth to secure our endpoints. In the past, this verification was controlled by the [`verify_jwt` flag](/docs/guides/functions/function-configuration#skipping-authorization-checks).

But unfortunately this method is incompatible with the new [JWT Signing Keys](/docs/guides/auth/signing-keys) and also caused trouble when attempting [third-party integration](https://github.com/orgs/supabase/discussions/34988#discussion-8199151).

That's why we decided to no longer implicitly force JWT verification, but instead suggest patterns and templates to handle this task. This allows users to own and control the auth code, instead of hiding it internally under Edge Runtime infrastructure.

<Admonition type="warning">

Following the [Upcoming changes](https://github.com/orgs/supabase/discussions/29260) timetable, the `verify_jwt` flag will still be supported and enabled by default. To move to the new [JWT Signing Keys](/docs/guides/auth/signing-keys), you need to manually [skip the authorization checks](/docs/guides/functions/function-configuration#skipping-authorization-checks) and follow the steps below.

</Admonition>

## Verifying JWT

### Using Supabase template

We've prepared some [JWT verification](https://github.com/supabase/supabase/tree/master/examples/edge-functions/supabase/functions/custom-jwt-validation) templates, that can be found [here](https://github.com/supabase/supabase/tree/master/examples/edge-functions/supabase/functions/_shared/jwt).

To simply verify incoming requests you can download the specified template and start using it:

```bash
curl -O https://raw.githubusercontent.com/supabase/supabase/refs/heads/master/examples/edge-functions/supabase/functions/_shared/jwt/default.ts
```

```ts
import { AuthMiddleware } from '../_shared/jwt/default.ts'

Deno.serve((r) =>
  AuthMiddleware(r, async (req) => {
    const { name } = await req.json()

    return Response.json({ message: `hello ${name}` })
  })
)
```

### Integrating with Supabase Auth

You can also use the Supabase Auth to verify users

```ts
import 'jsr:@supabase/functions-js/edge-runtime.d.ts'
import { createClient } from 'npm:@supabase/supabase-js@2'

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_PUBLISHABLE_KEY')!
)

Deno.serve(async (req) => {
  const authHeader = req.headers.get('Authorization')!
  const token = authHeader.replace('Bearer ', '')

  const { data, error } = await supabase.auth.getClaims(token)
  const userEmail = data?.claims?.email
  if (!userEmail || error) {
    return Response.json(
      { msg: 'Invalid JWT' },
      {
        status: 401,
      }
    )
  }

  return Response.json({ message: `hello ${userEmail}` })
})
```

### Using JWT library

The popular `jose` library can be used to verify received JWTs, like the following example:

```ts
import { createRemoteJWKSet, jwtVerify } from 'https://deno.land/x/jose@v4.14.4/index.ts'

// While developing you may populate the 'SB_JWT_ISSUER' to match the same issuer from your local environment
// The issuer can also be customised from [auth.jwt_issuer] property
const SUPABASE_JWT_ISSUER = Deno.env.get("SB_JWT_ISSUER") ??
  Deno.env.get("SUPABASE_URL") + "/auth/v1";

const SUPABASE_JWT_KEYS = createRemoteJWKSet(
  new URL(Deno.env.get("SUPABASE_URL")! + "/auth/v1/.well-known/jwks.json"),
);

function getAuthToken(req: Request) {
  const authHeader = req.headers.get("authorization");
  if (!authHeader) {
    throw new Error("Missing authorization header");
  }
  const [bearer, token] = authHeader.split(" ");
  if (bearer !== "Bearer") {
    throw new Error(`Auth header is not 'Bearer {token}'`);
  }
  return token;
}

function verifySupabaseJWT(jwt: string) {
  return jwtVerify(jwt, SUPABASE_JWT_KEYS, {
    issuer: SUPABASE_JWT_ISSUER,
  });
}

Deno.serve(async (req: Request) => {
  if (req.method !== 'OPTIONS') {
    try {
      const token = getAuthToken(req)
      const isValidJWT = await verifySupabaseJWT(token)

      if (!isValidJWT) {
        return Response.json({ msg: 'Invalid JWT' }, {
          status: 401,
        })
      }
    } catch (e) {
      console.error(e)
      return Response.json({ msg: e.toString() }, {
        status: 401,
      })
    }
  }

  const { name } = await req.json()
  return Response.json({ message: `hello ${name}` })
}
```
