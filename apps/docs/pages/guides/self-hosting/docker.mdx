import Layout from '~/layouts/DefaultGuideLayout'

export const meta = {
  title: 'Self-Hosting with Docker',
  description: 'Learn how to configure and deploy Supabase with Docker.',
  subtitle: 'Learn how to configure and deploy Supabase with Docker.',
}

Docker is the easiest way to get started with self-hosted Supabase. This guide assumes you are running the command from the machine you intend to host from.

## Before you begin

You need the following installed in your system: [Git](https://git-scm.com/downloads) and Docker ([Windows](https://docs.docker.com/desktop/install/windows-install/), [MacOS](https://docs.docker.com/desktop/install/mac-install/), or [Linux](https://docs.docker.com/desktop/install/linux-install/)).

## Running Supabase

Running a self-hosted Supabase project is simple. Follow the steps below:

```sh
# Get the code
git clone --depth 1 https://github.com/supabase/supabase

# Go to the docker folder
cd supabase/docker

# Copy the fake env vars
cp .env.example .env

# Pull the latest images
docker compose pull

## Start the services (in detached mode)
docker compose up -d
```

After all the services have started you should be able to see them running in the background:

```sh
docker compose ps
```

Now visit [localhost:8000](http://localhost:8000) to start using Supabase Studio. You will be prompted for a username and password. By default, the username is `supabase` and the password is `this_password_is_insecure_and_should_be_updated`. Please secure your services as soon as possible using the instructions below.

## Securing your services

While we provided you with some example secrets for getting started, you should NEVER deploy your Supabase setup using the defaults we have provided.

### Generate API Keys

Create a new `JWT_SECRET` and store it securely. 

We can use your JWT Secret to generate new `anon` and `service` API keys using the form below. Update the "JWT Secret" and then run "Generate JWT" once for the `SERVICE_KEY` and once for the `ANON_KEY`:

<JwtGenerator />

### Update API Keys

Replace the values the `.env` file:

  - `ANON_KEY` - replace with an `anon` key
  - `SERVICE_ROLE_KEY` - replace with a `service` key

You will need to restart the services for the changes to take effect.

### Update Secrets

Update the `.env` file with your own secrets. In particular, these are required:

- `POSTGRES_PASSWORD`: the password for the `postgres` role.
- `JWT_SECRET`: used by PostgREST and GoTrue, among others.
- `SITE_URL`: the base URL of your site.
- `SMTP_*`: mail server credentials. You can use any SMTP server.

You will need to restart the services for the changes to take effect.

### Dashboard Authentication

The dashboard is protected with Basic Authentication. The default user and password MUST be updated before using Supabase in production. You can update the `./docker/volumes/api/kong.yml` file with your own credentials. For example:

```yaml
basicauth_credentials:
- consumer: DASHBOARD
  username: user_one
  password: password_one
- consumer: DASHBOARD
  username: user_two
  password: password_two
```

You will need to restart the services for the changes to take effect.

## Restarting all services

You can restart services to pick up any configuration changes by running:

```sh
docker compose restart
```

Be aware that this will result in downtime while the services are restarting.

## Stopping all services

You can stop Supabase by running `docker compose stop` in same directory as your `docker-compose.yml` file.

## Uninstalling

You can stop Supabase by running `docker compose down -v` in same directory as your `docker-compose.yml` file.

## Advanced configuration

Each system can be [configured](../self-hosting#configuration) independently. Some of the most important configuration options are:

- Consider deploying the database to a different server than the rest of the services
- Update Storage to use S3 instead of the filesystem backend
- Configure Auth with a production-ready SMTP server

### Deploying Edge Functions

Edge Functions are stored in `volumes/functions`. The default setup has a `hello` Function that you can invoke on `http://localhost:8000/functions/v1/hello`. You can add new Functions as `volumes/functions/<FUNCTION_NAME>/index.ts`.

### Setting database's `log_min_messages`

By default, `docker compose` sets the database's `log_min_messages` configuration to `fatal` to prevent redundant logs generated by Realtime. You can configure `log_min_messages` using any of the Postgres [Severity Levels](https://www.postgresql.org/docs/current/runtime-config-logging.html#RUNTIME-CONFIG-SEVERITY-LEVELS).


### File storage backend on macOS

By default, Storage backend is set to `file`, which is to use local files as the storage backend. For macOS compatibility, you need to choose `VirtioFS` as the Docker container file sharing implementation (in Docker Desktop -> Preferences -> General).

### Setting up logging with the Analytics server

Additional configuration is required for self-hosting the Analytics server. For the full setup instructions, see [Self Hosting Analytics](https://supabase.com/docs/reference/self-hosting-analytics/introduction#getting-started).


export const Page = ({ children }) => <Layout meta={meta} children={children} />

export default Page
