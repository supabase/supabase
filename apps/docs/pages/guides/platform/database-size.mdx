import Layout from '~/layouts/DefaultGuideLayout'

export const meta = {
  id: 'database-size',
  title: 'Database size',
  description: 'Understanding how database size applies to your subscription.',
}

Database size refers to the _monthly average storage usage_, as reported by Postgres. This metric is reported in your project's [billing usage](https://app.supabase.com/project/_/settings/billing/usage) and is updated daily. As you read this document we will refer to "database size" and "disk size":

- "Database size" is the total size of used storage from your database.
- "Disk size" describes the size of the underlying available storage.

## Database space management

### Database size

This SQL query will show the current size of your Postgres database:

```sql
select
  sum(pg_database_size (pg_database.datname)) / (1024 * 1024) as db_size_mb
from
  pg_database;
```

This value is reported in the [database settings page](https://app.supabase.com/project/_/settings/database).

Database Space is consumed primarily by your data, indexes, and materialized views. You can reduce your disk size by removing any of these and running a Vacuum operation.

<Admonition type="note">

Depending on your billing tier, your database can go into read-only mode which can prevent you inserting and deleting data. There are instructions for managing read-only mode in the [Disk Management](#disk-management) section.

</Admonition>

### Vacuum operations

Postgres does not immediately reclaim the physical space used by dead tuples (i.e., deleted rows) in the DB. They are marked as "removed" until a [vacuum operation](https://www.postgresql.org/docs/current/routine-vacuuming.html) is executed. As a result, deleting data from your database may not immediately reduce the reported disk usage.

<Admonition type="note">

Vacuum operations can temporarily increase resource utilization, which may adversely impact the observed performance of your project until the maintenance is completed.

</Admonition>

Supabase projects have automatic vacuuming enabled, which ensures that these operations are performed regularly to keep the database healthy and performant.
It is possible to [fine-tune](https://www.percona.com/blog/2018/08/10/tuning-autovacuum-in-postgresql-and-autovacuum-internals/)
the [autovacuum parameters](https://www.enterprisedb.com/blog/postgresql-vacuum-and-analyze-best-practice-tips),
or [manually initiate](https://www.postgresql.org/docs/current/sql-vacuum.html) vacuum operations.
Running a manual vacuum after deleting large amounts of data from your DB could help reduce the database size reported by Postgres.

### Preoccupied Space

New Supabase projects have a database size of ~40-60mb. This space includes pre-installed extensions, schemas, and default Postgres data. Additional database size is used when installing extensions, even if those extensions are inactive.

## Disk management

Supabase uses network-attached storage to balance performance with scalability. The behavior of your disk depends on your billing tier.

### Free Tier

[Free Tier](#free-tier-project) projects will enter ['read only'](#free-tier-project-read-only-mode) mode when you exceed the 500mb limit.

In read-only mode, clients will encounter errors such as `cannot execute INSERT in a read-only transaction`.
Regular operation (read-write mode) is automatically re-enabled once database storage is below the 500mb database size limit.

#### Increasing available database space

- If you are in [read-only](#free-tier-project-read-only-mode) mode:

  - Then you can [upgrade to the Pro or Enterprise tier](https://app.supabase.com/project/_/settings/billing/subscription) to go beyond the 500mb database size limit.
  - However; If your project database is already in [read-only](#free-tier-project-read-only-mode) mode, run the following command to change the transaction mode to read-write for your session
    (This allows you to delete data from within the session).

    ```sql
    SET
      default_transaction_read_only = 'off';
    ```

- If you are over your limit, but not in [read-only](#free-tier-project-read-only-mode) mode yet, it's important to reduce your Database size as your database might go into [read-only](#free-tier-project-read-only-mode) mode.

### Paid tier project

For **Pro and Enterprise tier projects**, your [disk size expands automatically](#paid-tier-disk-auto-scaling).

#### Paid tier disk auto-scaling

Pro and Enterprise have Disk size auto-scaling. Database storage expands automatically when the database reaches 90% of the disk size. The disk is expanded to be 50% larger (e.g., 8GB -> 12GB).
Auto-scaling can only take place once every 6 hours.

<Admonition type="caution">

If you intend to import a lot of data into your database that would require multiple storage expansions then [reach out to our team](https://app.supabase.com/support/new), otherwise your project might enter a ['read-only' mode](#paid-tier-project-read-only-mode).

</Admonition>

You may require multiple storage expansions in a short period of time. For example, you need to upload more than 1.5x the current size of your database storage. This will lead to your database entering a [read-only mode](#paid-tier-project-read-only-mode). You can avoid this by [contacting the support team](https://app.supabase.com/support/new) so that your database can be resized to a sufficient amount before you start uploading to it.

If you need more than 1024TB of disk size, you can [contact us](https://app.supabase.com/support/new) to learn more about the Enterprise plan.

#### Paid tier project 'read-only' mode

Database storage expands, at most, once every 6 hours.
If within those 6 hours you reach 95% of the disk space, your project will enter read-only mode.

In read-only mode, clients will encounter errors such as `cannot execute INSERT in a read-only transaction`.
Regular operation (read-write mode) is automatically re-enabled once usage is below 95% of the disk size, or when the database automatically resizes after the 6 hour period.

#### Increasing available database space

For Pro and Enterprise tier projects that are [nearing their disk size limit](#paid-tier-project-read-only-mode), you can increase available disk size by deleting data from your project's database to lower its disk usage.

If your project database is already in [read-only](#paid-tier-project-read-only-mode) mode, run the following command to change the transaction mode to read-write for your session:

```sql
SET
  default_transaction_read_only = 'off';
```

This allows you to delete data from within the session.

export const Page = ({ children }) => <Layout meta={meta} children={children} />

export default Page
