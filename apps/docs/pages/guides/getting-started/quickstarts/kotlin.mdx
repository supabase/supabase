import Layout from '~/layouts/DefaultGuideLayout'
import StepHikeCompact from '~/components/StepHikeCompact'

export const meta = {
  title: 'Use Supabase with Android Kotlin',
  subtitle:
    'Learn how to create a Supabase project, add some sample data to your database, and query the data from an Android Kotlin app.',
  breadcrumb: 'Framework Quickstarts',
}

<StepHikeCompact>

  <StepHikeCompact.Step step={1}>
    <StepHikeCompact.Details title="Set up a Supabase project">

    [Create a new project](https://app.supabase.com) in the Supabase Dashboard.

    After your project is ready, create a table in your Supabase database using the [SQL Editor](https://app.supabase.com/project/_/sql) in the Dashboard. Use the following SQL statement to create all tables.

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>

     ```sql SQL_EDITOR
      -- Create products table
      create table
        public.products (
          _id bigint generated by default as identity not null,
          productid text not null,
          name text null,
          description text null,
          price real null,
          image text null,
          category text null,
          nutrition text null,
          constraint products_pkey primary key (productid),
        ) tablespace pg_default;

      ````

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={2}>

    <StepHikeCompact.Details title="Create an Android app with Android Studio">
      Open Android Studio > New > New Android Project.

    </StepHikeCompact.Details>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={3}>

    <StepHikeCompact.Details title="Install the Supabase client library">
    Import Supabase and all required dependencies. Replace the version placeholders `$supabase_version` and `$ktor_version` with the respective latest versions.

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
        implementation "io.github.jan-tennert.supabase:postgrest-kt:$supabase_version"
        implementation "io.ktor:ktor-client-android:$ktor_version"
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={4}>

    <StepHikeCompact.Details title="Install the serializable plugin">
    Open the `build.gradle` (app), add the serialization plugin to use annotation for data parsing. Please note that the plugin version should be the same as the Kotlin version in your app.
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
        plugins {
            ...
            id 'org.jetbrains.kotlin.plugin.serialization' version '$kotlin_version'
            ...
        }
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={5}>

    <StepHikeCompact.Details title="Initialize the Supabase client">
    You can create a Supabase client whenever you need to perform an API call. That being said, it is recommended to use a dependency injection library like [Hilt](https://developer.android.com/training/dependency-injection/hilt-android#kts).
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>

      ```kotlin
      val client = createSupabaseClient(
          supabaseUrl = "https://xyzcompany.supabase.co",
          supabaseKey = "public-anon-key"
        ) {
          install(Postgrest)
      }
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={6}>

    <StepHikeCompact.Details title="Create a data transfer object">
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
      @Serializable
      data class ProductDto(
          @SerialName("productid")
          val productId: String,
          @SerialName("name")
          val name: String,
          @SerialName("description")
          val description: String,
          @SerialName("price")
          val price: Double,
          @SerialName("image")
          val image: String,
          @SerialName("category")
          val category: String,
          @SerialName("nutrition")
          val nutrition: String,
          @SerialName("_id")
          val _id: Int,
      )
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={7}>

    <StepHikeCompact.Details title="Create a domain object">
      This kind of object will be consumed by the view.
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
      data class Product(
          val productId: String,
          val name: String,
          val description: String,
          val price: Double,
          val image: String,
          val category: String,
          val nutrition: String,
          val _id: Int,
      )
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={8}>

    <StepHikeCompact.Details title="Query data from the app">
      Create a repository to interact with the data source.
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
      interface ProductRepository {
        fun getProducts(): List<ProductDto>
      }

      class ProductRepositoryImpl @Inject constructor(
            private val postgrest: Postgrest,
        ) : ProductRepository {
          override suspend fun getProducts(): List<ProductDto> {
            val result = client.postgrest["products"]
                .select().decodeList<ProductDto>()
            // Handle result data for next step
            return result
          }
      }
      ```
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

   <StepHikeCompact.Step step={9}>
    <StepHikeCompact.Details title="Create a module to provide repository">
    Use [Hilt](https://developer.android.com/training/dependency-injection/hilt-android) for dependency injection.
    </StepHikeCompact.Details>
    <StepHikeCompact.Code>
      ```kotlin
      InstallIn(SingletonComponent::class)
      @Module
      abstract class RepositoryModule {
          @Binds
          abstract fun bindProductRepository(impl: ProductRepositoryImpl): ProductRepository
      }
      ```
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={10}>
    <StepHikeCompact.Details title="Get data from ViewModel inside a coroutine scope">
    Add the `@Inject` annotation to use the repository in a ViewModel.
    </StepHikeCompact.Details>
    <StepHikeCompact.Code>
      ```kotlin
      class ProductListViewModel @Inject constructor(
        private val productRepository: ProductRepository
      ) : ViewModel() {

        private val _productList = MutableStateFlow<List<Product>?>(listOf())
        val productList: Flow<List<Product>?> = _productList

        init {
            getProducts()
        }

        fun getProducts() {
            viewModelScope.launch {
                val products = productRepository.getProducts()
                _productList.emit(products?.map { it -> it.asDomainModel() })
            }
        }

        private fun ProductDto.asDomainModel(): Product {
          return Product(
              productId = this.productId,
              name = this.name,
              price = this.price,
              image = this.image,
              description = this.description,
              category = this.category,
              nutrition = this.nutrition,
              _id = this._id
          )
      }
      ```
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

    <StepHikeCompact.Step step={11}>
    <StepHikeCompact.Details title="Observe data in a Composable">
    </StepHikeCompact.Details>
    <StepHikeCompact.Code>
      ```kotlin
        @Composable
        fun ProductListScreen(
            modifier: Modifier = Modifier,
            navController: NavController,
            viewModel: ProductListViewModel = hiltViewModel(),
        ) {
            val productList = viewModel.productList.collectAsState(initial = listOf()).value
            if (!productList.isNullOrEmpty()) {
                LazyColumn(
                    modifier = modifier.padding(24.dp),
                    contentPadding = PaddingValues(5.dp)
                ) {
                    items(productList) { item ->
                        ProductListItem(
                            product = item,
                            modifier = modifier,
                            onClick = {
                                navController.navigate(
                                    ProductDetailsDestination.createRouteWithParam(
                                        item.id
                                    )
                                )
                            },
                        )
                    }
                }
            }
        }
      ```
      </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={12}>
    <StepHikeCompact.Details title="Start the app">

    </StepHikeCompact.Details>

  </StepHikeCompact.Step>

</StepHikeCompact>

export const Page = ({ children }) => <Layout meta={meta} children={children} hideToc={true} />

export default Page
