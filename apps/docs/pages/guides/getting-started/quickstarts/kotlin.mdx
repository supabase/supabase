import Layout from '~/layouts/DefaultGuideLayout'
import StepHikeCompact from '~/components/StepHikeCompact'

export const meta = {
  title: 'Use Supabase with Android Kotlin',
  subtitle:
    'Learn how to create a Supabase project, add some sample data to your database, and query the data from a Android Kotlin app.',
  breadcrumb: 'Framework Quickstarts',
}

<StepHikeCompact>

  <StepHikeCompact.Step step={1}>
    <StepHikeCompact.Details title="Set up a Supabase project">

    [Create a new project](https://app.supabase.com) in the Supabase Dashboard.

    After your project is ready, create a table in your Supabase database using the [SQL Editor](https://app.supabase.com/project/_/sql) in the Dashboard. Use the following SQL statement to create all tables.

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>

     ```sql SQL_EDITOR
      -- Create products table
      create table
        public.products (
          _id bigint generated by default as identity not null,
          productid text not null,
          name text null,
          description text null,
          price real null,
          image text null,
          category text null,
          nutrition text null,
          constraint products_pkey primary key (productid),
        ) tablespace pg_default;

      ````

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={2}>

    <StepHikeCompact.Details title="Create an Android app with Android Studio">
      Setup environment for Android Development following official document.
      Open Android Studio > New > New Android Project

    </StepHikeCompact.Details>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={3}>

    <StepHikeCompact.Details title="Install the Supabase client library">
    Setup Supabase libraries requires some others libraries from ktor, so make sure all dependencies are added.
    Replace the dependency version placeholders `$supabase_version` and `$ktor_version` with the latest versions as shown below.
    <div style={{ display: 'flex', flexDirection: 'row', alignItems: 'center' }}> 
      <a href="https://github.com/supabase-community/supabase-kt/releases" style={{ marginRight: '8px' }}> 
          <img src="https://img.shields.io/github/release/supabase-community/supabase-kt?label=supabase-kt stable" alt="latest stable supabase-kt version"/> 
      </a> 
      <a href="https://github.com/ktorio/ktor/releases"> 
          <img src="https://img.shields.io/github/v/release/ktorio/ktor.svg?label=ktor" alt="latest ktor version"/> 
      </a> 
    </div> 

    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
        implementation "io.github.jan-tennert.supabase:postgrest-kt-android:$supabase_version"
        implementation "io.ktor:ktor-client-android:$ktor_version"
        implementation "io.ktor:ktor-client-logging-jvm:$ktor_version"
        implementation "io.ktor:ktor-client-core:$ktor_version"
        implementation "io.ktor:ktor-client-cio:$ktor_version"
        implementation "io.ktor:ktor-utils-jvm:$ktor_version"
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={4}>

    <StepHikeCompact.Details title="Install the serializable plugin">
    Open `build.gradle` (app), add serialization plugin to use annotation for data parsing. Please note that the plugin version should be the same with Kotlin version in your app.
    <a href="https://github.com/JetBrains/kotlin" style={{ marginRight: '8px' }}> 
          <img src="https://img.shields.io/maven-central/v/org.jetbrains.kotlin/kotlin-maven-plugin.svg?label=kotlin_version" alt="latest stable supabase-kt version"/> 
    </a>
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
        plugins {
            ...
            id 'org.jetbrains.kotlin.plugin.serialization' version '$kotlin_version'
            ...
        }
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={5}>

    <StepHikeCompact.Details title="Initialize the Supabase client">
    You can create a whenever you need to perform some API call.
    However, it is recommended that we should provide this kind of instance by using dependency injection library like Hilt. So see the code below to provide them properly. This is better for testability and maintainability
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>

      ```kotlin
      // Handy create instance when need
      val client = createSupabaseClient(
          supabaseUrl = "https://xyzcompany.supabase.co", 
          supabaseKey = "public-anon-key"
        ) {
              install(GoTrue)
              install(Postgrest)
              install(Storage)
          }
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={6}>

    <StepHikeCompact.Details title="Create data transfer object">
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
      @Serializable
      data class ProductDto(
          @SerialName("productid")
          val productId: String,
          @SerialName("name")
          val name: String,
          @SerialName("description")
          val description: String,
          @SerialName("price")
          val price: Double,
          @SerialName("image")
          val image: String,
          @SerialName("category")
          val category: String,
          @SerialName("nutrition")
          val nutrition: String,
          @SerialName("_id")
          val _id: Int,
      )
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={7}>

    <StepHikeCompact.Details title="Create domain object">
      This kind of object will be consumed by the view
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
      data class Product(
          val productId: String,
          val name: String,
          val description: String,
          val price: Double,
          val image: String,
          val category: String,
          val nutrition: String,
          val _id: Int,
      )
      ```

    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={8}>

    <StepHikeCompact.Details title="Query data from the app">
      
    </StepHikeCompact.Details>

    <StepHikeCompact.Code>
      ```kotlin
      suspend fun getProducts(): ProductDto {
        val result = client.postgrest["products"]
            .select().decodeList<ProductDto>()
        // Handle result data for next step
        return result
      }
      ```
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={9}>
    <StepHikeCompact.Details title="Get data from ViewModel inside a coroutine scope">
     

    </StepHikeCompact.Details>
    <StepHikeCompact.Code>
      ```kotlin
      class ProductListViewModel @Inject constructor(
        private val productRepository: ProductRepository
      ) : ViewModel() {

        private val _productList = MutableStateFlow<List<Product>?>(listOf())
        val productList: Flow<List<Product>?> = _productList

        init {
            getProducts()
        }

        fun getProducts() {
            viewModelScope.launch {
                val products = productRepository.getProducts()
                _productList.emit(products?.map { it -> it.asDomainModel() })
            }
        }

        private fun ProductDto.asDomainModel(): Product {
          return Product(
              productId = this.productId,
              name = this.name,
              price = this.price,
              image = this.image,
              description = this.description,
              category = this.category,
              nutrition = this.nutrition,
              _id = this._id 
          )
      }
      ```
    </StepHikeCompact.Code>

  </StepHikeCompact.Step>

    <StepHikeCompact.Step step={10}>
    <StepHikeCompact.Details title="Observe data in Composable">
    </StepHikeCompact.Details>
    <StepHikeCompact.Code>
      ```kotlin
        @Composable
        fun ProductListScreen(
            modifier: Modifier = Modifier,
            navController: NavController,
            viewModel: ProductListViewModel = hiltViewModel(),
        ) {
            val productList = viewModel.productList.collectAsState(initial = listOf()).value
            if (!productList.isNullOrEmpty()) {
                LazyColumn(
                    modifier = modifier.padding(24.dp),
                    contentPadding = PaddingValues(5.dp)
                ) {
                    items(productList) { item ->
                        ProductListItem(
                            product = item,
                            modifier = modifier,
                            onClick = {
                                navController.navigate(
                                    ProductDetailsDestination.createRouteWithParam(
                                        item.id
                                    )
                                )
                            },
                        )
                    }
                }
            }
        }
      ```
      </StepHikeCompact.Code>

  </StepHikeCompact.Step>

  <StepHikeCompact.Step step={11}>
    <StepHikeCompact.Details title="Start the app">

    </StepHikeCompact.Details>

  </StepHikeCompact.Step>

</StepHikeCompact>

export const Page = ({ children }) => <Layout meta={meta} children={children} hideToc={true} />

export default Page
