import Layout from '~/layouts/DefaultGuideLayout'

export const meta = {
  id: 'securing-your-api',
  title: 'Securing your API',
  description: 'Securing your Serverless API with Postgres Row Level Security.',
}

The Serverless APIs are designed to work with Postgres Row Level Security (RLS). If you use Supabase [Auth](/docs/guides/auth), you can restrict data based on the logged-in user.
To control access to your data, you can use [Policies](/docs/guides/auth#policies).

## Enabling Row Level Security

When you create a table in Postgres, Row Level Security is disabled by default. To enable RLS:

<Tabs
  scrollable
  size="small"
  type="underlined"
  defaultActiveId="dashboard"
>
<TabPanel id="dashboard" label="Dashboard">

1. Go to the [Authentication](https://app.supabase.com/project/_/auth/users) page in the Dashboard.
2. Click on **Policies** in the sidebar.
3. Select **Enable RLS** to enable Row Level Security.

</TabPanel>
<TabPanel id="sql" label="SQL">

```sql
alter table
  todos enable row level security;
```

</TabPanel>
</Tabs>

With RLS enabled, you can create Policies that allow or disallow users to access and update data. We provide a detailed guide for creating Row Level Security Policies in our [Authorization documentation](/docs/guides/auth/row-level-security).

## API Keys

Supabase provides two default keys when you create a project: an `anon` key, and a `service_role` key. You can find both keys in the [API Settings](https://app.supabase.com/project/_/settings/api).

These keys both map to Postgres roles - you can find an `anon` user and a `service_role` user in the [Roles](http://app.supabase.com/project/_/database/roles) section of the dashboard. The keys are both long-lived JWTs. If you decode these keys, you will see that they contain the "role", an "issued date", and an "expiry date" in the future.

```json
{
  "role": "anon",
  "iat": 1625137684,
  "exp": 1940713684
}
```

### The `anon` key

The `anon` key has very few privileges. You can use it in your [RLS policies](/docs/guides/auth/row-level-security) for "anonymous" access. For example, this policy will allow access to the `profiles` table:

```sql
create policy "Allow anonymous access" on profiles to anon for
select
  using (true);
```

And similarity for disallowing access:

```sql
create policy "Disallow anonymous access" on profiles to anon for
select
  using (false);
```

If you are using [Supabase Auth](/docs/guides/auth/overview), then the `anon` role will automatically update to `authenticated` once a user is logged in:

```sql
create policy "Allow access to authenticated users" on profiles to authenticated for
select
  using (true);
```

### The `service_role` key

The "service_role" is a predefined Postgres role with elevated privileges, designed to perform various administrative and service-related tasks. It can bypass Row Level Security, so it should only be used on a private server.

<Admonition type="caution">
  Never expose the `service_role` key in a browser or anywhere where a user can see it.
</Admonition>

A common use case for the `service_role` key is running data analytics jobs on the backend. To support joins on user id, it is often useful to grant the service role read access to `auth.users` table.

```sql
grant
select
  on table auth.users to service_role;
```

We have [partnered with GitHub](https://github.blog/changelog/2022-03-28-supabase-is-now-a-github-secret-scanning-partner/) to scan for Supabase `service_role` keys pushed to public repositories.
If they detect any keys with service_role privileges being pushed to GitHub, they will forward the API key to us, so that we can automatically revoke the detected secrets and notify you, protecting your data against malicious actors.

## Safeguards towards accidental deletes and updates

By default, all projects have the [safeupdate](https://github.com/eradman/pg-safeupdate) Postgres extension enabled for API queries.
This ensures that `delete()` and `update()` requests will fail if there are no filters provided.
To confirm that safeupdate is enabled for API queries, run the following query:

```sql
select
  usename,
  useconfig
from
  pg_shadow
where
  usename = 'authenticator';
```

The expected value for `useconfig` should be:

```sql
['session_preload_libraries=supautils, safeupdate']
```

export const Page = ({ children }) => <Layout meta={meta} children={children} />

export default Page
