---
title: PostgreSQL Event Triggers without superuser access
description: Using Postgres Hooks to allow regular users to create event triggers
author: steve_chavez
author_url: https://github.com/steve-chavez
author_image_url: https://github.com/steve-chavez.png
image: 2025-05-08-event-triggers-wo-superuser/cover-event-triggers.png
thumb: 2025-05-08-event-triggers-wo-superuser/cover-event-triggers.png
categories:
  - postgres
tags:
  - postgres
  - planetpg
  - event triggers
  - extensions
date: '2025-05-08'
---

Event triggers in Postgres are powerful, but only SUPERUSERS can create them. In cloud environments, giving SUPERUSER access to end users isn't an option.

But thanks to Postgres extensibility, we can allow regular users to create event triggers, in a safe way.

In this blog post, we’ll explain how we do this in the supautils extension, using a combination of the Utility Hook and the Function Manager Hook.

## Privileged Role

![utility hook](/images/blog/2025-05-08-event-triggers-wo-superuser/utility-hook.png)

The core of supautils is the “privileged role”, which is a role that serves as proxy to superuser. It provides a safe subset of superuser capabilities and it’s accessible to end users.

When the privileged role does a `CREATE EVENT TRIGGER`, we intercept the statement with an Utility Hook (`ProcessUtility_hook`). Here we elevate the role to a superuser, continuing the usual flow and allowing the creation on Postgres core [^1].

Creating an event trigger like this is not safe though, as it would allow privilege escalation.

## The privilege escalation problem

A problem arises once an event trigger is created:

- It targets every role.
- It runs using the target role privileges [^2].

This means that a malicious user can create an event trigger like:

```sql
create or replace function become_super()
    returns event_trigger
    language plpgsql as
$$
begin
    alter role malicious superuser;
end;
$$;

create event trigger malicious_event_trigger on ddl_command_end
execute procedure become_super();
```

And once a SUPERUSER trips on the malicious event trigger, it will fire with its privileges. Making the malicious user a SUPERUSER.

## Skipping Event Triggers

![fmgr hook](/images/blog/2025-05-08-event-triggers-wo-superuser/fmgr-hook.png)

A solution would be skipping user event triggers for superusers.

The Function Manager hook (`fmgr_hook`) allows us to intercept and modify functions’ execution.

We can intercept the event trigger function and replace it with a “noop”. Postgres doesn’t provide a noop function, but we can use the existing `version()` function to achieve the same effect.

Besides superusers, we also want to skip user event triggers for “reserved roles” [^3]. These are used for managed services (like `pgbouncer`).

## User Event Triggers

This now allows users to safely create event triggers, without superuser access:

```sql
-- use the privileged role, which is configured to be "postgres"
set role postgres;
select current_setting('is_superuser'); -- prove it's not a superuser
 current_setting
-----------------
 off
(1 row)

-- now create the event trigger
create function show_current_user()
returns event_trigger as $$
begin
  raise notice 'the event trigger is executed for %', current_user;
end;
$$ language plpgsql;

create event trigger myevtrig on ddl_command_end
execute procedure func();

-- check it succeeds
create table foo();
NOTICE:  the event trigger is executed for privileged_role
```

## Future in Postgres core

We would also like to allow regular user event triggers in Postgres core. To this end, we’ve submitted [some patches](https://www.postgresql.org/message-id/flat/CAGRrpzbtYDkg7_xwfzrqByYgCJQbbL38tADyuN%2B6tAkbA-Pnkg%40mail.gmail.com) which are generating discussion.

Note that Postgres core user event triggers will likely be more restricted than the supautils version.

## Try it out

User event triggers are now available on the Supabase platform, for new projects created on the Central EU (`eu-central-1` ) region. We’ll be progressively rolling the feature out to other regions as we gather feedback.

You can also git clone the [supautils](https://github.com/supabase/supautils/) repo and `make install` it in your own deployment.

[^1]: As a last step, we change the owner of the event trigger to the privileged role so it be altered or dropped by end users.

[^2]: This is not true if you mark the event trigger function as SECURITY DEFINER, then it will run with the privileges of the function owner. But this is not a usual practice on event triggers, as they usually want to preserve the context of the current user.

[^3]: These are configurable. You can read more about reserved roles [here](https://supabase.com/blog/roles-postgres-hooks).
